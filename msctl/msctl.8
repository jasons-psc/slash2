.\" $Id$
.\" %PSC_START_COPYRIGHT%
.\" -----------------------------------------------------------------------------
.\" Copyright (c) 2008-2011, Pittsburgh Supercomputing Center (PSC).
.\"
.\" Permission to use, copy, and modify this software and its documentation
.\" without fee for personal use or non-commercial use within your organization
.\" is hereby granted, provided that the above copyright notice is preserved in
.\" all copies and that the copyright and this permission notice appear in
.\" supporting documentation.  Permission to redistribute this software to other
.\" organizations or individuals is not permitted without the written permission
.\" of the Pittsburgh Supercomputing Center.  PSC makes no representations about
.\" the suitability of this software for any purpose.  It is provided "as is"
.\" without express or implied warranty.
.\" -----------------------------------------------------------------------------
.\" %PSC_END_COPYRIGHT%
.\" %PFL_MODULES rpc fuse %
.Dd February 22, 2011
.Dt MSCTL 8
.ds volume PSC \- SLASH Administrator's Manual
.Os http://www.psc.edu/
.Sh NAME
.Nm msctl
.Nd
.Tn SLASH
file system mount daemon runtime control
.Sh SYNOPSIS
.Nm msctl
.Op Fl HIRv
.Op Fl c Ar cmd
.Op Fl f Ar cmd
.Op Fl p Ar paramspec
.Op Fl Q Ar replrqspec
.Op Fl r Ar replstspec
.Op Fl S Ar socket
.Op Fl s Ar showspec
.Op Fl U Ar replrqspec
.Sh DESCRIPTION
The
.Nm
utility controls
.Xr mount_slash 8
behavior.
.Pp
The options are as follows:
.Bl -tag -width 3n
.\" %PFL_INCLUDE $PFL_BASE/doc/pflctl/c.mdoc {
.\"	daemon	=> qq{mount_slash},
.\"	cmds	=> {
.\" #		reconfig => "Reload configuration"
.\"	}
.It Fl c Ar cmd
Instruct
.Xr mount_slash 8
to perform one of the following actions:
.Pp
.Bl -tag -compact -offset 3n -width 13n
.It Cm exit
Completely terminate daemon execution.
.El
.\" }%
.It Fl f Ar cmd
Perform a
.Tn SLASH
file system operation.
.Pp
The following actions are available:
.Bl -tag -width 1n
.It Xo
.Sm off
.Cm new-repl-policy
.Cm = Ar repl-policy
.Cm : Ar fn
.Sm on
.Xc
Set the default replication policy for new bmaps
.Pq file data blocks
for the specified file
.Ar fn .
.Pp
The following replication policies are recognized:
.Bl -tag -width one-time
.It Cm one-time
Replication requests are completed once then removed from the system.
Data replicated will continue to exist at replicas even after new
.Tn I/O
invalidates these copies.
.Pp
See
.Fl r
for checking the replication status of bmaps and retrieving the current
default replication policy of files.
.Pp
This is the default mode.
.It Cm persist
Perpetually propagate any new
.Tn I/O
done to a bmap to other replicas where the bmap is registered for replication.
.El
.It Xo
.Sm off
.Cm bmap-repl-policy= Ar repl-policy
.Cm : Ar bmapspec Cm : Ar fn
.Sm on
.Xc
Set the replication policy for all bmaps specified in
.Ar bmapspec
for the given file
.Ar fn .
.Pp
.Ar bmapspec
has the following format:
.Bd -literal -offset 3n
.Sm off
.Ar bmapno-min
.Op Li -\& Ar bmapno-max
.Op Li ,\& Ar ...
.Sm on
.Ed
.Pp
The value
.Sq Li *
will affect all bmaps currently residing in the file.
.Pp
See
.Fl r
for inspecting the replication policy of bmaps.
.El
.\" %PFL_INCLUDE $PFL_BASE/doc/pflctl/H.mdoc {
.It Fl H
Suppress display of headers.
.\" }%
.\" %PFL_INCLUDE $PFL_BASE/doc/pflctl/I.mdoc {
.It Fl I
Display large numerical values accurately instead of rounded with
postfixes of demonination such as
.Sq G
for gigabytes,
.Sq M
for megabytes, etc.\&
.Pq inhuman mode .
.\" }%
.\" %PFL_INCLUDE $PFL_BASE/doc/pflctl/p.mdoc {
.\"	subsys => {
.\"		bmap		=> qq{Block map structures},
.\"		fcmh		=> qq{.Tn FID\ncache members}
.\"	}
.It Fl p Ar paramspec
Query/manipulate operational parameters.
.Ar paramspec
has the following format:
.Pp
.Bd -unfilled -offset 3n
.Sm off
.Oo Ar thread-name Ns Li .\& Oc Ar param
.Op Oo Li +- Oc Li = Ar value
.Sm on
.Ed
.Pp
Some parameters are read-only.
Some support modification by the assignment operators
.Li +=
and
.Li -= .
.Pp
See
.Sx Thread Specification
for details on specifying
.Ar thread-name .
The default behavior is to apply the operation to all applicable threads.
.Pp
.Ar param
may be one of the following:
.Bl -tag -width 1n -offset 3n
.It Cm fuse.debug
.Tn FUSE
debug messages.
.It Cm fuse.version
.Tn FUSE
interface version.
.It Cm lnet.networks
.Tn LNET
network configuration.
.It Cm lnet.port
If applicable,
.Xr tcp 7
port to use to connect to remote
.Tn LNET
peers.
.It Cm lnet.sdp
Whether
.Tn LNET
is using the sockets direct protocol.
.It Cm log.file
File path name where log messages will be written.
This value is write-only.
If the
.Li +=
assignment operator is used, this file will not be truncated.
.It Cm log.format
The header prepended to server log messages.
See
.Xr pflenv 7
for details on this format.
.It Cm log.level Ns Op . Ns Ar subsystem
The logging level of debug message output.
.Pp
.Ar subsystem
may be one of the following:
.Pp
.Bl -tag -compact -offset 3n -width 13n
.It Cm bmap
Block map structures
.It Cm def
Default
.It Cm fcmh
.Tn FID
cache members
.It Cm lnet
Lustre networking stack
.It Cm mem
Memory allocations and releases
.It Cm rpc
Network remote procedure calls
.El
.Pp
If
.Ar subsystem
is left unspecified, all subsystems will be accessed.
.Pp
The log level value may be one of the following:
.Pp
.Bl -tag -compact -offset 3n -width 13n
.It Cm 0 , none
No logging
.It Cm 1 , error
Recoverable failures
.It Cm 2 , warn
Something wrong which requires attention
.Pq default
.It Cm 3 , notice
Something unusual which recommends attention
.It Cm 4 , info
Informational messages
.It Cm 5 , debug
Debugging messages
.It Cm 6 , trace , all
All messages
.El
.It Cm pool. Ns Ar name
Access the memory pool specified by
.Ar name .
The following sub-fields are available:
.Pp
.Bl -tag -compact -offset 3n -width 13n
.It Cm max
Upper bound for number of entries to which auto-sized pools can grow.
.It Cm min
Lower bound for number of entries to which auto-sized pools can shrink.
.It Cm thres
Threshold for unused items for auto-sized pools before items are freed.
.It Cm total
Current number of entries contained in pool.
.El
.It Cm pscfs.attr_timeout
Amount of time to cache
.Xr stat 2
information in
.Tn FUSE .
.It Cm pscfs.entry_timeout
Amount of time to cache name space entries in
.Tn FUSE .
.It Cm rlim
Process resource limits.
See
.Xr getrlimit 2
or
.Xr ulimit 1
for more information.
.Pp
.Bl -tag -compact -offset 3n -width 13n
.It Cm nofiles
Corresponds to
.Dv RLIMIT_NOFILE ,
the maximum number of open files.
.El
.El
.\" }%
.It Fl Q Ar replrqspec
Perform data replication as specified by
.Ar replrqspec .
The
.Tn I/O
node responsible for the data regions specified will propagate the data
to all other
.Tn I/O
systems specified.
.Pp
.Ar replrqspec
has the following format:
.Bd -unfilled -offset 3n
.Sm off
.Ar ios Op Cm ,\& Ar ...
.Cm :\& Ar bmapno-min
.Op Cm -\& Ar bmapno-max
.Op Cm ,\& Ar ...
.Cm :\& Ar filename
.Sm on
.Ed
.Pp
If the special value
.Sq Li *
is supplied as the bmap specification, all present bmaps in the file
will be replicated;
otherwise, only the bmaps with the given indexes will be replicated.
.Pp
By default, bmaps are registered for a single replication after which
they can be invalidated on any replicas they were copied to if new
.Tn I/O
is done.
See
.Fl f
for information on modifying the replication policy.
.Pp
This option may be specified multiple times.
.It Fl R
Apply operations on files specified in
.Fl f ,
.Fl Q ,
.Fl r ,
and
.Fl U
recursively.
.It Fl r Ar file
List the specified
.Ar file Ap s
replication status.
Information about every bmap
.Pq data region
of the file including
.Tn I/O
systems where they have been registered for replication and their status
is displayed.
.Pp
If
.Ar file
is the special value
.Sq \&: ,
all pending replications will be queried.
Note that file names are unavailable in this mode.
.Pp
The following legend lists the states a block map may be in for the
one-time or persistent replication policies:
.Bl -column "scheduled for replicati" "one-ti" "Indicator" -offset 3n
.It Sy State                   Ta Sy One-time Ta Sy Persistent
.It ================================================
.It active                     Ta Li + Ta Li *
.It inactive                   Ta Li - Ta Li /
.It queued for replication     Ta Li q Ta Li Q
.It replicating                Ta Li s Ta Li S
.It garbage                    Ta Li g Ta Li G
.It garbage being reclaimed    Ta Li x Ta Li X
.It truncated                  Ta Li t Ta Li T
.It resolving truncation       Ta Li p Ta Li P
.El
.Pp
See
.Fl f
for details on modifying a bmap's replication policy.
.Pp
This option may be specified multiple times.
.\" %PFL_INCLUDE $PFL_BASE/doc/pflctl/S.mdoc {
.\"	sock => "/var/run/mount_slash. Ns Ic %h Ns Pa .sock"
.It Fl S Ar socket
Specify an alternative socket file.
The following tokens are replaced in the file name specified:
.Pp
.Bl -tag -offset 3n -width Ds -compact
.It Cm %h
the machine hostname
.It Cm %n
the daemon executable base name, i.e.\&
.Li mount_slash
.It Cm %%
a literal
.Sq %
character
.El
.Pp
The default is
.Pa /var/run/mount_slash. Ns Ic %h Ns Pa .sock .
.\" }%
.\" %PFL_INCLUDE $PFL_BASE/doc/pflctl/show.mdoc {
.\"	show => {
.\"		connections	=> qq{Status of\n.Tn SLASH\npeers on network.},
.\"		fidcache	=> qq{.Tn FID\n.Pq file- Ns Tn ID\ncache members.}
.\"	},
.\"	hashtables => {
.\"		fidc		=> qq{files\n.Po file\n.Tn ID\ncache\n.Pc},
.\"		resnid		=> qq{network resources\n.Pq network Tn ID}
.\"	},
.\"	pools => {
.\"		bmap		=> qq{Block map structures},
.\"	},
.\"	listcaches => {
.\"		bmapflush	=> "Bmaps awaiting flush completion",
.\"		bmaptimeout	=> "Expired bmaps awaiting release",
.\"		bmpcLru		=> "Reapable bmap structures",
.\"		dircache	=> "Directory entries",
.\"		fcmhbusy	=> "Files with pending activity e.g.\\&\n.Tn I/O",
.\"		fcmhidle	=> "Clean\n.Pq reapable\nfiles"
.\"	}
.It Fl s Ar showspec
Show values.
.Ar showspec
has the following format:
.Bd -unfilled -offset 3n
.Sm off
.Ar param
.Op : Ar subspec
.Sm on
.Ed
.Pp
.Ar param
may be specified as any non-ambiguous prefix abbreviation of the
following:
.Pp
.Bl -tag -width 1n -offset 3n
.It Cm connections
Status of
.Tn SLASH
peers on network.
.It Cm fidcache
.Tn FID
.Pq file- Ns Tn ID
cache members.
.It Cm hashtables
Hash table statistics.
.Ar subspec
has the following format:
.Bd -unfilled -offset 3n
.Ar hash-table Ns Op , Ns Ar ...
.Ed
.Pp
.Ar hash-table
may be one of the following:
.Pp
.Bl -tag -compact -offset 3n -width 13n
.It Cm fidc
files
.Po file
.Tn ID
cache
.Pc
.It Cm resnid
network resources
.Pq network Tn ID
.El
.Pp
If
.Ar subspec
is left unspecified, all hash tables will be accessed.
.It Cm iostats
.Tn I/O
statistics.
.Ar subspec
has the following format:
.Pp
.Bd -unfilled -offset 3n
.Ar iostats Ns Op , Ns Ar ...
.Ed
.Pp
.Ar iostats
may be one of the following:
.Pp
.Bl -tag -compact -offset 3n -width 3n
.It Cm lni-rcv- Ns Ar if ,
.It Cm lni-snd- Ns Ar if
Data sent/received per
.Tn LNET
networking interface.
.Pp
.It Cm lusklnd- Ns Ar mode Ns Cm -rcv ,
.It Cm lusklnd- Ns Ar mode Ns Cm -snd
Data sent/received over userland socket networking device.
.Ar mode
may be
.Cm pasv
.Pq passive
or
.Cm aggr
.Pq aggregate .
.Pp
.El
.Pp
If
.Ar subspec
is left unspecified, all
.Tn I/O
statistics will be accessed.
.It Cm listcaches
List cache statistics.
.Ar subspec
has the following format:
.Pp
.Bd -unfilled -offset 3n
.Ar list Ns Op , Ns Ar ...
.Ed
.Pp
.Ar list
may be one of the following:
.Pp
.Bl -tag -compact -offset 3n -width 13n
.It Cm bmapflush
Bmaps awaiting flush completion
.It Cm bmaptimeout
Expired bmaps awaiting release
.It Cm bmpcLru
Reapable bmap structures
.It Cm dircache
Directory entries
.It Cm fcmhbusy
Files with pending activity e.g.\&
.Tn I/O
.It Cm fcmhidle
Clean
.Pq reapable
files
.El
.Pp
If
.Ar subspec
is left unspecified, all list caches will be accessed.
.It Cm loglevels
Thread logging levels.
.Ar subspec
has the following format:
.Bd -unfilled -offset 3n
.Ar thread Ns Op , Ns Ar ...
.Ed
.Pp
See
.Sx Thread Specification
for details on specifying
.Ar thread .
If
.Ar subspec
is left unspecified, all threads will be accessed.
.It Cm pools
Memory pool statistics.
.Ar subspec
has the following format:
.Bd -unfilled -offset 3n
.Ar pool Ns Op , Ns Ar ...
.Ed
.Pp
.Ar pool
may be one of the following:
.Pp
.Bl -tag -compact -offset 3n -width 13n
.It Cm bmap
Block map structures
.El
.Pp
If
.Ar subspec
is left unspecified, all pools will be accessed.
.It Cm rpcsvcs
.Tn RPC
services.
.It Cm threads
Daemon thread activity and statistics.
.Ar subspec
has the following format:
.Bd -unfilled -offset 3n
.Ar thread Ns Op , Ns Ar ...
.Ed
.Pp
See
.Sx Thread Specification
for details on specifying
.Ar thread .
If
.Ar subspec
is left unspecified, all threads will be accessed.
.El
.Pp
The special value
.Sq \&?
may also be specified to display a list of recognized values.
.\" }%
.It Fl U Ar replrqspec
Cancel ongoing file replication requests as specified by
.Ar replrqspec .
See
.Fl Q
for details on the format of
.Ar replrqspec .
.Pp
This option may be specified multiple times.
.It Fl v
Verbose mode:
display additional information about each operation being performed.
.El
.\" %PFL_INCLUDE $PFL_BASE/doc/pflctl/thr.mdoc {
.\"	thrs => {
.\"		q{msbflushthr Ns Ar %d}		=> qq{Bmap flusher thread},
.\"		q{msbflushrpcthr}		=> qq{Bmap flusher asynchronous\n.Tn RPC\nreply thread},
.\"		q{msbrlsthr}			=> qq{Bmap timed releaser thread},
.\"		q{msconnthr- Ns Ar %s}		=> qq{Remote server connection monitor},
.\"		q{msctlacthr}			=> qq{.Nm\nconnection acceptor},
.\"		q{msctlthr}			=> qq{.Nm\nconnection processor},
.\"		q{mseqpollthr}			=> qq{Lustre\n.Fn LNetEQPoll\nthread},
.\"		q{msfsmgrthr}			=> qq{Userland file system manager thread\n.Pq e.g. FUSE},
.\"		q{msfsthr Ns Ar %d}		=> qq{File system system caller service thread},
.\"		q{msrcmthr Ns Ar %02d}		=> qq{.Tn MDS RPC\nrequest service},
.\"		q{mstiosthr}			=> qq{Timed\n.Tn I/O\nstats updater thread},
.\"		q{msusklndplthr Ns Ar %d}	=> qq{Lustre userland socket poll thread},
.\"	}
.Ss Thread Specification
Options which take
.Ar thread-name
parameters may be specified by one or more of the following tokens,
separated by commas:
.Pp
.Bl -tag -compact -offset 3n -width 16n
.It Cm msbflushrpcthr
Bmap flusher asynchronous
.Tn RPC
reply thread
.It Cm msbflushthr Ns Ar %d
Bmap flusher thread
.It Cm msbrlsthr
Bmap timed releaser thread
.It Cm msconnthr- Ns Ar %s
Remote server connection monitor
.It Cm msctlacthr
.Nm
connection acceptor
.It Cm msctlthr
.Nm
connection processor
.It Cm mseqpollthr
Lustre
.Fn LNetEQPoll
thread
.It Cm msfsmgrthr
Userland file system manager thread
.Pq e.g. FUSE
.It Cm msfsthr Ns Ar %d
File system system caller service thread
.It Cm msrcmthr Ns Ar %02d
.Tn MDS RPC
request service
.It Cm mstiosthr
Timed
.Tn I/O
stats updater thread
.It Cm msusklndplthr Ns Ar %d
Lustre userland socket poll thread
.It Cm everyone
All threads
.Pq default, where applicable
.El
.\" }%
.Sh FILES
.Bl -tag -width Pa
.It Pa /var/run/mount_slash. Ns Ic %h Ns Pa .sock
default
.Xr mount_slash 8
control socket
.El
.Sh SEE ALSO
.Xr sladm 7 ,
.Xr mount_slash 8
